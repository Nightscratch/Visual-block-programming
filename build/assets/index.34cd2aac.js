(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const r of t)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function l(t){const r={};return t.integrity&&(r.integrity=t.integrity),t.referrerpolicy&&(r.referrerPolicy=t.referrerpolicy),t.crossorigin==="use-credentials"?r.credentials="include":t.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(t){if(t.ep)return;t.ep=!0;const r=l(t);fetch(t.href,r)}})();let m=1;const T=()=>{document.getElementById("app").style.zoom=m},z=()=>{m+=.5,m>4&&(m=4),T()},J=()=>{m-=.5,m<.5&&(m=.5),T()};document.getElementById("zoomIn").addEventListener("click",J);document.getElementById("zoomOut").addEventListener("click",z);let K=document.getElementById("app"),S=document.getElementById("zoom");const C=(e,n,l=!1)=>{let o,t,r=u=>{if(u.target!=e&&u.target.getAttribute("dragId")!=e.getAttribute("blockId")||u.button==2)return!0;u=u||window.event,u.preventDefault(),K.appendChild(e),o=e.getAttribute("blockId"),document.getElementById("screen").style.height=S.scrollTop+S.offsetHeight-16+"px",document.getElementById("screen").style.width=S.scrollLeft+S.offsetWidth-16+"px",t={y:u.clientY/m-(e.getBoundingClientRect().y+S.scrollTop/m),x:u.clientX/m-(e.getBoundingClientRect().x+S.scrollLeft/m)},document.onmouseup=c,document.onmousemove=s},s=u=>{u=u||window.event,u.preventDefault(),e.style.top=u.clientY/m-t.y+"px",e.style.left=u.clientX/m-t.x+"px",n(o,!1)},c=()=>{document.onmouseup=null,document.onmousemove=null,n(o)};e.onmousedown=r,l&&r(l)},P=`<div dragId="blockId">\r
    <div class="block-in">\r
        <div class="inline-block" dragId="blockId">\r
            <p dragId="blockId">Move(</p>\r
            <div class="input" prentId="blockId" inputId="arg1"></div>\r
            <p dragId="blockId">,</p>\r
            <div class="input" prentId="blockId" inputId="arg2"></div>\r
            <p dragId="blockId">)</p>\r
        </div>\r
    </div>\r
</div>\r
<div prentId="blockId" inputId="next"></div>`,X={isTopLevel:!1,defaultInput:"next",topOnly:!1,html(e){return P.replace(/blockId/g,e)},inputs(){return{arg1:{type:0,value:null},arg2:{type:0,value:null},next:{type:1,value:null}}},compiler(e,n){return`move(${e.arg1},${e.arg2});${e.next}`}},Y=`<div>\r
    <div class="block-in">\r
        <div class="inline-block">\r
            <p dragId="blockId">\u5982\u679C</p>\r
            <div class="input" prentId="blockId" inputId="condition1"></div>\r
        </div>\r
    </div>\r
    <div class="inline">\r
        <div class="column"></div>\r
        <div class="input-transparent" prentId="blockId" inputId="do1"></div>\r
    </div>\r
    <div class="block-in">\r
        <div class="inline-block" dragId="blockId">\r
            <img class="right" src="./images/back.svg" />\r
        </div>\r
    </div>\r
</div>\r
<div prentId="blockId" inputId="next"></div>`,H={isTopLevel:!1,defaultInput:"do1",topOnly:!1,html(e){return Y.replace(/blockId/g,e)},inputs(){return{do1:{type:1,value:null},condition1:{type:0,value:null},next:{type:1,value:null}}},compiler(e,n){return`if (${e.condition1}){${e.do1}}${e.next}`}},Q=`<div>\r
    <div class="block-in">\r
        <div class="inline-block" dragId="blockId">\r
            <p dragId="blockId">\u5F53\u7A0B\u5E8F\u542F\u52A8\u65F6</p>\r
        </div>\r
    </div>\r
</div>\r
<div prentId="blockId" inputId="next"></div>`,W={isTopLevel:!0,defaultInput:"next",topOnly:!0,html(e){return Q.replace(/blockId/g,e)},inputs(){return{next:{type:1,value:null}}},compiler(e,n){return`const start =()=>{${e.next}}`}},G=`<div>\r
    <div class="block-in">\r
        <div class="inline-block report-only" dragId="blockId">\r
            <p dragId="blockId">\u6587\u672C</p>\r
            <div>\r
                <input type="text" id="input">\r
            </div>\r
        </div>\r
    </div>\r
</div>`,U={isTopLevel:!1,defaultInput:null,topOnly:!0,html(e){return G.replace(/blockId/g,e)},inputs(){return{}},compiler(e,n,l){return`"${l.querySelector('[id="input"]').value}"`},save:{toFile(e,n){return e.text=n.querySelector('[id="input"]').value,e}},load:{toJson(e){return delete e.text,e},changeDom(e,n){return n.querySelector('[id="input"]').value=e.text,n}}},V=`<div>\r
    <div class="block-in">\r
        <div class="inline-block report-only" dragId="blockId">\r
            <p dragId="blockId">\u6570\u5B57</p>\r
            <div>\r
                <input id="input" type="number">\r
            </div>\r
        </div>\r
    </div>\r
</div>`,Z={isTopLevel:!1,defaultInput:null,topOnly:!0,html(e){return V.replace(/blockId/g,e)},inputs(){return{}},compiler(e,n,l){return`${l.querySelector('[id="input"]').value}`},save:{toFile(e,n){return e.number=n.querySelector('[id="input"]').value,e}},load:{toJson(e){return delete e.number,e},changeDom(e,n){return n.querySelector('[id="input"]').value=e.number,n}}},_=`<div dragId="blockId">\r
    <div class="block-in">\r
        <div class="inline-block report-only" dragId="blockId">\r
            <p dragId="blockId">abs(</p>\r
            <div class="input" prentId="blockId" inputId="arg"></div>\r
            <p dragId="blockId">)</p>\r
        </div>\r
    </div>\r
</div>\r
<div prentId="blockId" inputId="next"></div>`,ee={isTopLevel:!1,defaultInput:"next",topOnly:!0,html(e){return _.replace(/blockId/g,e)},inputs(){return{arg:{type:0,value:null}}},compiler(e,n){return`Math.abs(${e.arg});${e.next}`}},y={move:X,ifelse:H,start:W,text:U,number:Z,equalTo:ee};function te(e){const n=new WeakMap;function l(t){return typeof t=="object"&&t||typeof t=="function"}function o(t){if(!l(t))return t;if([Date,RegExp].includes(t.constructor))return new t.constructor(t);if(typeof t=="function")return new Function("return "+t.toString())();const r=n.get(t);if(r)return r;if(t instanceof Map){const d=new Map;return n.set(t,d),t.forEach((a,p)=>{l(a)?d.set(p,o(a)):d.set(p,a)}),d}if(t instanceof Set){const d=new Set;return n.set(t,d),t.forEach(a=>{l(a)?d.add(o(a)):d.add(a)}),d}const s=Reflect.ownKeys(t),c=Object.getOwnPropertyDescriptors(t),u=Object.create(Object.getPrototypeOf(t),c);return n.set(t,u),s.forEach(d=>{const a=t[d];l(a)?u[d]=o(a):u[d]=a}),u}return o(e)}var w={};const R=(e,n)=>{let l=y[e.type],o={};for(const t in e.inputs){let r=e.inputs[t];r.value?o[t]=R(w[r.value.data],r.value.data):t=="next"?o[t]="":o[t]="null"}return l.compiler(o,e,document.querySelector(`[blockid="${n}"]`))},ne=e=>{w=e;let n="";for(const l in w){let o=w[l];y[o.type].isTopLevel&&(n+=R(o,l))}return n},le=e=>{let n={};for(const l in e){let o=e[l],t=document.querySelector(`[blockid="${l}"]`);console.log(t);let r=y[o.type];r.save&&r.save.toFile?n[l]=r.save.toFile(o,t):n[l]=o,n[l].x=t.style.left,n[l].y=t.style.top}return n};let F={},N=[];const j=(e,n,l)=>{let o=n[e],t=y[o.type];t.load&&t.load.changeDom&&t.load.changeDom(o,l),l.style.left=o.x,l.style.top=o.y,delete o.x,delete o.y,t.load&&t.load.toJson&&t.load.toJson(o),F[e]=o;for(const r in o.inputs){let s=o.inputs[r];if(s.value){let c=ie(n[s.value.data].type,s.value.data);N.push({selfBlockDom:c,selfBlockId:s.value.data,prentId:e,targetBlockInputIndex:r}),l.querySelector(`[inputid="${r}"]`).appendChild(j(s.value.data,n,c));debugger}}return l},oe=(e,n)=>{document.getElementById("app").innerHTML="",F={};for(const l in e){console.log("sss",e[l]);const o=e[l];if(!o.prent){debugger;N=[],ce(j(l,e,h(o.type,!1,l)),N,l);debugger}}},E=20;var I=null,i={},$={},B=null,v=null;const re=(e,n)=>{let l=e;if(!i[l].inputs[n])return e;for(;i[l].inputs[n].value;)l=i[l].inputs[n].value.data;return Number(l)},k=(e,n,l,o)=>{if(e.target.getAttribute("blockid")!=n&&e.target.getAttribute("dragId")!=n)return!0;if(e=e||window.e,e.preventDefault(),e.button==2)return null;delete i[n].prent;let t=I.querySelector(`[blockid="${n}"]`);i[l].inputs[o].value=null,t.style.top=g(t,"y")+"px",t.style.left=g(t,"x")+"px",t.setAttribute("class","block"),I.appendChild(t),C(t,D,e)},q=(e,n)=>{if(e=e||window.e,e.preventDefault(),e.target.getAttribute("blockid")!=n&&e.target.getAttribute("dragId")!=n)return null;B.style.display="block",B.style.top=e.clientY+5+"px",B.style.left=e.clientX+10+"px",$.open=!0,$.target={type:1,data:String(n)}},D=(e,n=!0)=>{n&&v.remove();let l=[],o=O(e);for(let r in i){let s=i[r];if(!(r==e||!s.defaultInput)){for(const c in i[e].inputs){if(s.topOnly&&i[e].inputs[c].type==1||i[e].inputs[c].type!=1||i[r].prent||c!="next"&&i[e].inputs[c].value)continue;let u=O(r),d=document.querySelector(`[prentId="${e}"][inputId="${c}"]`),a=Math.abs(u.getBoundingClientRect().left-d.getBoundingClientRect().left),p=Math.abs(u.getBoundingClientRect().top-d.getBoundingClientRect().top),f=1;p<E&&a<E&&l.push({distance:a+p,targetBlockId:r,targetBlockDom:u,dragBlockInputId:c,type:f})}for(const c in s.inputs){if(!i[e].defaultInput&&s.inputs[c].type==1||i[e].topOnly&&s.inputs[c].type==1)continue;let u=document.querySelector(`[prentId="${r}"][inputId="${c}"]`),d=Math.abs(u.getBoundingClientRect().left-o.getBoundingClientRect().left),a=Math.abs(u.getBoundingClientRect().top-o.getBoundingClientRect().top);d<E&&a<E&&l.push({distance:d+a,targetBlockId:r,targetBlockInputIndex:c,targetBlockInputDom:u,type:0})}}}if(l.length==0)return v.remove(),null;l.sort((r,s)=>r.distance-s.distance);let t=l[0];if(t.type==0){let{targetBlockId:r,targetBlockInputIndex:s,targetBlockInputDom:c}=t;if(i[r].inputs[s].value){let u=i[r].inputs[s].value.data,d=O(u),a=re(e,"next");if(s=="next"){let p=i[e].defaultInput;if(!n)return c.insertBefore(v,c.childNodes[0]),!0;p!="next"&&!i[e].inputs[p].value?(document.querySelector(`[prentId="${e}"][inputId="${p}"]`).appendChild(d),i[e].inputs[p].value={type:1,data:u},i[u].prent={inputId:p,blockId:e},d.onmousedown=f=>{k(f,u,e,s)}):(document.querySelector(`[prentId="${a}"][inputId="next"]`).appendChild(d),i[a].inputs.next.value={type:1,data:u},i[u].prent={inputId:"next",blockId:a},d.onmousedown=f=>{k(f,u,a,"next")})}else if(i[u].defaultInput)if(i[e].defaultInput){if(!n)return c.insertBefore(v,c.childNodes[0]),!0;let p=i[e].defaultInput,f;p=="next"?f=a:i[e].inputs[p].value?(f=a,p="next"):f=e,document.querySelector(`[prentId="${f}"][inputId="${p}"]`).appendChild(d),i[f].inputs[p].value={data:u,type:1},i[u].prent={inputId:p,blockId:f},d.onmousedown=b=>{k(b,u,f,p)};debugger}else{if(!n)return c.append(v),!0;d.style.top=g(d,"y")+20+"px",d.style.left=g(d,"x")+20+"px",I.appendChild(d),delete i[u].prent,d.setAttribute("class","block"),C(d,D)}else{if(!n)return c.append(v),!0;d.style.top=g(d,"y")+20+"px",d.style.left=g(d,"x")+20+"px",I.appendChild(d),delete i[u].prent,d.setAttribute("class","block"),C(d,D)}}if(!n)return c.append(v),!0;i[r].inputs[s].value={type:1,data:e},i[e].prent={blockId:r,inputId:s},c.appendChild(o),o.setAttribute("class","block-input"),o.onmousedown=u=>{k(u,e,r,s)}}else if(t.type==1){let{targetBlockId:r,targetBlockDom:s,dragBlockInputId:c}=t,u=document.querySelector(`[prentId="${e}"][inputId="${c}"]`);if(!n)return u.append(v),!0;u.append(s),i[r].prent={blockId:e,inputId:c},i[e].inputs[c].value={type:1,data:r},s.setAttribute("class","block-input"),s.onmousedown=d=>{k(d,r,e,c)}}return null},L=(e,n=Object.keys(i).length)=>{let l=document.createElement("div");return l.setAttribute("blockId",`${n}`),l.setAttribute("class","block"),l.innerHTML=y[e].html(n),l},ie=(e,n=Object.keys(i).length)=>{let l=L(e,n);return l.setAttribute("class","input-block"),l},h=(e,n=!0,l)=>{let o;if(n?o=L(e):o=L(e,l),I.appendChild(o),n){C(o,D);let t=Object.keys(i).length;o.oncontextmenu=r=>{q(r,t)},i[t]={type:e,inputs:y[e].inputs(),isTopLevel:y[e].isTopLevel,defaultInput:y[e].defaultInput,topOnly:y[e].topOnly}}return o},M=e=>{let n=[];for(const l in i[e].inputs){let o=i[e].inputs[l];o.value&&o.value&&(n.push(o.value.data),n=n.concat(M(o.value.data)))}return n},ue=e=>{O(e).remove(),i[e].prent&&(i[i[e].prent.blockId].inputs[i[e].prent.inputId].value=null);let n=M(e);for(const l of n)delete i[l];delete i[e]},g=(e,n)=>n=="x"?e.getBoundingClientRect().x+document.getElementById("zoom").scrollLeft/m:e.getBoundingClientRect().y+document.getElementById("zoom").scrollTop/m,de=e=>{let n=M(e),l=Number(Object.keys(i)[Object.keys(i).length-1])+1;n.unshift(e);let o=document.querySelector(`[blockid="${e}"]`),t=o.cloneNode(!0);t.style.left=g(o,"x")+10+"px",t.style.top=g(o,"y")+10+"px",I.appendChild(t);for(const r of n){let s=i[r];i[String(Number(r)+l)]=te(s);let c=i[String(Number(r)+l)];document.createElement("div").appendChild(t.cloneNode(!0));let d=(p,f,b=()=>{})=>{let x=t.querySelectorAll(p)[0];x||(x=t),x.setAttribute(f,String(Number(r)+l)),b(x)},a=(p,f)=>{let b=t.querySelectorAll(p);for(let x of b)x.setAttribute(f,String(Number(r)+l))};c.prent&&(i[String(Number(r)+l)].prent.blockId=String(Number(i[String(Number(r)+l)].prent.blockId)+l)),d(`[blockid="${r}"]`,"blockid",p=>{let f=i[String(Number(r)+l)];r==e?(p.setAttribute("class","block"),C(p,D)):p.onmousedown=b=>{k(b,String(Number(r)+l),f.prent.blockId,f.prent.inputId)},p.oncontextmenu=b=>{q(b,String(Number(r)+l))}}),a(`[dragid="${r}"]`,"dragid");for(const p in c.inputs)a(`[prentid="${r}"][inputId="${p}"]`,"prentid"),c.inputs[p].value&&(c.inputs[p].value.data=String(Number(c.inputs[p].value.data)+l))}},ce=(e,n,l)=>{C(e,D),e.oncontextmenu=o=>{q(o,l)};for(const o of n)o.selfBlockDom.onmousedown=t=>{k(t,o.selfBlockId,o.prentId,o.targetBlockInputIndex)},o.selfBlockDom.oncontextmenu=t=>{q(t,o.selfBlockId)}},O=e=>document.querySelector(`[blockId="${e}"]`),A=()=>{B.style.display="none",$.open=!1},se=e=>{B=document.getElementById("menu"),I=e,i={},$={},v=document.getElementById("porDom"),v.remove(),console.log(v),I.onmousedown=n=>{if(n.target.getAttribute("id")=="menuItem")return null;A()},document.getElementById("menuCopy").addEventListener("click",()=>{de($.target.data),A()}),document.getElementById("menuDelet").addEventListener("click",()=>{ue($.target.data),A()})},pe=e=>{oe(e)},ae=()=>le(i),fe=()=>ne(i);se(document.getElementById("app"));h("move");h("ifelse");h("start");h("text");h("equalTo");h("number");document.getElementById("compiler").addEventListener("click",()=>{console.log(fe())});document.getElementById("saveFile").addEventListener("click",()=>{alert("\u8BF7\u6309F12\u6253\u5F00\u63A7\u5236\u53F0\uFF0C\u67E5\u770B\u6587\u4EF6"),console.log("\u79EF\u6728\u6587\u4EF6",ae())});document.getElementById("loadFile").addEventListener("click",()=>{pe(JSON.parse(prompt("\u6587\u4EF6json")))});
