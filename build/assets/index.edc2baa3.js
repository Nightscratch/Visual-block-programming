(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const d of r.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&o(d)}).observe(document,{childList:!0,subtree:!0});function l(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerpolicy&&(r.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?r.credentials="include":n.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(n){if(n.ep)return;n.ep=!0;const r=l(n);fetch(n.href,r)}})();let m=1;const R=()=>{document.getElementById("app").style.zoom=m},P=()=>{m+=.5,m>4&&(m=4),R()},X=()=>{m-=.5,m<.5&&(m=.5),R()};document.getElementById("zoomIn").addEventListener("click",X);document.getElementById("zoomOut").addEventListener("click",P);let Y=document.getElementById("app"),$=document.getElementById("zoom");const C=(e,t,l=!1)=>{let o,n,r=u=>{if(u.target!=e&&u.target.getAttribute("dragId")!=e.getAttribute("blockId")||u.button==2)return!0;u=u||window.event,u.preventDefault(),Y.appendChild(e),o=e.getAttribute("blockId"),document.getElementById("screen").style.height=$.scrollTop+$.offsetHeight-16+"px",document.getElementById("screen").style.width=$.scrollLeft+$.offsetWidth-16+"px",n={y:u.clientY/m-(e.getBoundingClientRect().y+$.scrollTop/m),x:u.clientX/m-(e.getBoundingClientRect().x+$.scrollLeft/m)},document.onmouseup=s,document.onmousemove=d},d=u=>{u=u||window.event,u.preventDefault(),e.style.top=u.clientY/m-n.y+"px",e.style.left=u.clientX/m-n.x+"px",t(o,!1)},s=()=>{document.onmouseup=null,document.onmousemove=null,t(o)};e.onmousedown=r,l&&r(l)},Q=`<div class="block-in" dragId="blockId">\r
    <div class="inline-block">\r
        <p dragId="blockId">Move(</p>\r
        <div class="input" prentId="blockId" inputId="arg1"></div>\r
        <p dragId="blockId">,</p>\r
        <div class="input" prentId="blockId" inputId="arg2"></div>\r
        <p dragId="blockId">)</p>\r
    </div>\r
</div>\r
\r
<div prentId="blockId" inputId="next"></div>`,W={defaultInput:"next",topOnly:!1,html(e){return Q.replace(/blockId/g,e)},inputs(){return{arg1:{type:0,value:null},arg2:{type:0,value:null},next:{type:1,value:null}}},compiler(e,t){return`move(${e.arg1},${e.arg2});${e.next}`}},J=`<div class="block-in" dragId="blockId">\r
    <div class="inline-block" dragId="blockId">\r
        <p dragId="blockId">\u5982\u679C</p>\r
        <div class="input" prentId="blockId" inputId="condition1"></div>\r
    </div>\r
</div>\r
<div class="inline">\r
    <div class="column"></div>\r
    <div class="input-transparent" prentId="blockId" inputId="do1"></div>\r
</div>\r
<div class="block-in" dragId="blockId">\r
    <div class="inline-block" dragId="blockId">\r
        <img class="right" src="./images/back.svg" />\r
    </div>\r
</div>\r
\r
<div prentId="blockId" inputId="next"></div>`,_={defaultInput:"do1",topOnly:!1,html(e){return J.replace(/blockId/g,e)},inputs(){return{do1:{type:1,value:null},condition1:{type:0,value:null},next:{type:1,value:null}}},compiler(e,t){return`if (${e.condition1}){${e.do1}}${e.next}`}},G=`\r
<div class="block-in">\r
    <div class="inline-block" dragId="blockId">\r
        <p dragId="blockId">\u5F53\u7A0B\u5E8F\u542F\u52A8\u65F6</p>\r
    </div>\r
</div>\r
<div prentId="blockId" inputId="next"></div>`,U={isTopLevel:!0,defaultInput:"next",topOnly:!0,html(e){return G.replace(/blockId/g,e)},inputs(){return{next:{type:1,value:null}}},compiler(e,t){return`const start =()=>{${e.next}}`}},V=`<div class="block-in">\r
    <div class="inline-block report-only" dragId="blockId">\r
            <p dragId="blockId">\u6587\u672C</p>\r
        <div>\r
            <input type="text" id="input">\r
        </div>\r
    </div>\r
</div>`,Z={defaultInput:null,topOnly:!0,html(e){return V.replace(/blockId/g,e)},inputs(){return{}},compiler(e,t,l){return`"${l.querySelector('[id="input"]').value}"`},save:{toFile(e,t){return e.self.text=t.querySelector('[id="input"]').value,e}},load:{initDom(e,t){return t.querySelector('[id="input"]').value=e.self.text,t}}},ee=`<div class="block-in">\r
    <div class="inline-block report-only"  dragId="blockId">\r
        <p dragId="blockId">\u6570\u5B57</p>\r
        <div>\r
            <input id="input" type="number">\r
        </div>\r
    </div>\r
</div>`,te={defaultInput:null,topOnly:!0,html(e){return ee.replace(/blockId/g,e)},inputs(){return{}},compiler(e,t,l){return`${l.querySelector('[id="input"]').value}`},save:{toFile(e,t){return e.self.number=t.querySelector('[id="input"]').value,e}},load:{initDom(e,t){return t.querySelector('[id="input"]').value=e.self.number,t}}},ne=`<div class="block-in" dragId="blockId">\r
    <div class="inline-block report-only" dragId="blockId">\r
        <p dragId="blockId">Arry(</p>\r
        <div id="inputs" prentId="blockId" class="inline">\r
\r
        </div>\r
        <p dragId="blockId">)</p>\r
        <button id="add">\u52A0</button>\r
        <button id="subtract">\u51CF</button>\r
    </div>\r
</div>\r
\r
<div prentId="blockId" inputId="next"></div>`,le=`\r
<div group="argId" prentId="blockId">\r
    <div class="input" prentId="blockId" inputId="argId"></div>\r
</div>`,oe={defaultInput:null,topOnly:!0,html(e){return ne.replace(/blockId/g,e)},inputs(){return{}},compiler(e,t){return`Math.abs(${e.arg});${e.next}`},load:{initDom(e,t,l,o){let n=(d,s=!0)=>{let u=document.createElement("template");u.innerHTML=le.replace(/argId/g,d).replace(/blockId/g,l),s&&(e.inputs[d]={type:0,value:null}),t.querySelector(`[id="inputs"][prentId="${l}"]`).appendChild(u.content)},r=()=>{let d=Object.keys(e.inputs);if(d.length>0){let s=e.inputs[d[d.length-1]];s.value&&K(s.value.data),t.querySelector(`[group="${d[d.length-1]}"][prentId="${l}"]`).remove(),delete e.inputs[d[d.length-1]],console.log(e.inputs)}};if(o){debugger;t.querySelector('[id="inputs"]').innerHTML="";for(let d in e.inputs)n(d,!1)}t.querySelector('[id="add"]').onclick=()=>{n(`item_${Object.keys(e.inputs).length+1}`)},t.querySelector('[id="subtract"]').onclick=d=>{console.log(d.target),r()}}}},y={move:W,ifelse:_,start:U,text:Z,number:te,equalTo:oe};function re(e){const t=new WeakMap;function l(n){return typeof n=="object"&&n||typeof n=="function"}function o(n){if(!l(n))return n;if([Date,RegExp].includes(n.constructor))return new n.constructor(n);if(typeof n=="function")return new Function("return "+n.toString())();const r=t.get(n);if(r)return r;if(n instanceof Map){const c=new Map;return t.set(n,c),n.forEach((a,f)=>{l(a)?c.set(f,o(a)):c.set(f,a)}),c}if(n instanceof Set){const c=new Set;return t.set(n,c),n.forEach(a=>{l(a)?c.add(o(a)):c.add(a)}),c}const d=Reflect.ownKeys(n),s=Object.getOwnPropertyDescriptors(n),u=Object.create(Object.getPrototypeOf(n),s);return t.set(n,u),d.forEach(c=>{const a=n[c];l(a)?u[c]=o(a):u[c]=a}),u}return o(e)}var O={};const j=(e,t)=>{let l=y[e.type],o={};for(const n in e.inputs){let r=e.inputs[n];r.value?o[n]=j(O[r.value.data],r.value.data):n=="next"?o[n]="":o[n]="null"}return l.compiler(o,e,document.querySelector(`[blockid="${t}"]`))},ie=e=>{O=e;let t="";for(const l in O){let o=O[l];y[o.type].isTopLevel&&(t+=j(o,l))}return t},ue=e=>{let t={};for(const l in e){let o=e[l],n=document.querySelector(`[blockid="${l}"]`);console.log(n);let r=y[o.type];r.save&&r.save.toFile?t[l]=r.save.toFile(o,n):t[l]=o,t[l].x=n.style.left,t[l].y=n.style.top}return t};let z={},M=[];const T=(e,t,l)=>{let o=t[e],n=y[o.type];l.style.left=o.x,l.style.top=o.y,delete o.x,delete o.y,z[e]=o,n.load&&n.load.initDom&&n.load.initDom(o,l,e,!0);for(const r in o.inputs){let d=o.inputs[r];if(d.value){let s=se(t[d.value.data].type,d.value.data);M.push({selfBlockDom:s,selfBlockId:d.value.data,prentId:e,targetBlockInputIndex:r}),l.querySelector(`[inputid="${r}"]`).appendChild(T(d.value.data,t,s));debugger}}return l},de=(e,t)=>{document.getElementById("app").innerHTML="",z={};for(const l in e){console.log("sss",e[l]);const o=e[l];if(!o.prent){debugger;M=[],ae(T(l,e,x(o.type,!1,l)),M,l);debugger}}},w=20;var I=null,i={},D={},E=null,b=null;const ce=(e,t)=>{let l=e;if(!i[l].inputs[t])return e;for(;i[l].inputs[t].value;)l=i[l].inputs[t].value.data;return Number(l)},h=(e,t,l,o)=>{if(e.target.getAttribute("blockid")!=t&&e.target.getAttribute("dragId")!=t)return!0;if(e=e||window.e,e.preventDefault(),e.button==2)return null;delete i[t].prent;let n=I.querySelector(`[blockid="${t}"]`);i[l].inputs[o].value=null,n.style.top=v(n,"y")+"px",n.style.left=v(n,"x")+"px",n.setAttribute("class","block"),I.appendChild(n),C(n,B,e)},A=(e,t)=>{if(e=e||window.e,e.preventDefault(),e.target.getAttribute("blockid")!=t&&e.target.getAttribute("dragId")!=t)return null;E.style.display="block",E.style.top=e.clientY+5+"px",E.style.left=e.clientX+10+"px",D.open=!0,D.target={type:1,data:String(t)}},B=(e,t=!0)=>{t&&b.remove();let l=[],o=q(e);for(let r in i){let d=i[r];if(r!=e){for(const s in i[e].inputs){if(d.topOnly&&i[e].inputs[s].type==1||i[e].inputs[s].type!=1||i[r].prent||s!="next"&&i[e].inputs[s].value)continue;let u=q(r),c=document.querySelector(`[prentId="${e}"][inputId="${s}"]`),a=Math.abs(u.getBoundingClientRect().left-c.getBoundingClientRect().left),f=Math.abs(u.getBoundingClientRect().top-c.getBoundingClientRect().top),p=1;f<w&&a<w&&l.push({distance:a+f,targetBlockId:r,targetBlockDom:u,dragBlockInputId:s,type:p})}for(const s in d.inputs){if(!i[e].defaultInput&&d.inputs[s].type==1||i[e].topOnly&&d.inputs[s].type==1)continue;let u=document.querySelector(`[prentId="${r}"][inputId="${s}"]`),c=Math.abs(u.getBoundingClientRect().left-o.getBoundingClientRect().left),a=Math.abs(u.getBoundingClientRect().top-o.getBoundingClientRect().top);c<w&&a<w&&l.push({distance:c+a,targetBlockId:r,targetBlockInputIndex:s,targetBlockInputDom:u,type:0})}}}if(l.length==0)return b.remove(),null;l.sort((r,d)=>r.distance-d.distance);let n=l[0];if(n.type==0){let{targetBlockId:r,targetBlockInputIndex:d,targetBlockInputDom:s}=n;if(i[r].inputs[d].value){let u=i[r].inputs[d].value.data,c=q(u),a=ce(e,"next");if(d=="next"){let f=i[e].defaultInput;if(!t)return s.insertBefore(b,s.childNodes[0]),!0;f!="next"&&!i[e].inputs[f].value?(document.querySelector(`[prentId="${e}"][inputId="${f}"]`).appendChild(c),i[e].inputs[f].value={type:1,data:u},i[u].prent={inputId:f,blockId:e},c.onmousedown=p=>{h(p,u,e,f)}):(document.querySelector(`[prentId="${a}"][inputId="next"]`).appendChild(c),i[a].inputs.next.value={type:1,data:u},i[u].prent={inputId:"next",blockId:a},c.onmousedown=p=>{h(p,u,a,"next")})}else{if(i[u].defaultInput)if(i[e].defaultInput){if(!t)return s.insertBefore(b,s.childNodes[0]),!0;let f=i[e].defaultInput,p;f=="next"?p=a:i[e].inputs[f].value?(p=a,f="next"):p=e,document.querySelector(`[prentId="${p}"][inputId="${f}"]`).appendChild(c),i[p].inputs[f].value={data:u,type:1},i[u].prent={inputId:f,blockId:p},c.onmousedown=g=>{h(g,u,p,f)}}else{if(!t)return s.append(b),!0;c.style.top=v(c,"y")+20+"px",c.style.left=v(c,"x")+20+"px",I.appendChild(c),delete i[u].prent,c.setAttribute("class","block"),C(c,B)}else{if(!t)return s.append(b),!0;c.style.top=v(c,"y")+20+"px",c.style.left=v(c,"x")+20+"px",I.appendChild(c),delete i[u].prent,c.setAttribute("class","block"),C(c,B)}debugger}}debugger;if(!t)return s.append(b),!0;i[r].inputs[d].value={type:1,data:e},i[e].prent={blockId:r,inputId:d},s.appendChild(o),o.setAttribute("class","block-input"),o.onmousedown=u=>{h(u,e,r,d)}}else if(n.type==1){let{targetBlockId:r,targetBlockDom:d,dragBlockInputId:s}=n,u=document.querySelector(`[prentId="${e}"][inputId="${s}"]`);if(!t)return u.append(b),!0;u.append(d),i[r].prent={blockId:e,inputId:s},i[e].inputs[s].value={type:1,data:r},d.setAttribute("class","block-input"),d.onmousedown=c=>{h(c,r,e,s)}}return null},L=(e,t=Object.keys(i).length)=>{let l=document.createElement("div");return l.setAttribute("blockId",`${t}`),l.setAttribute("class","block"),l.innerHTML=y[e].html(t),l},se=(e,t=Object.keys(i).length)=>{let l=L(e,t);return l.setAttribute("class","input-block"),l},x=(e,t=!0,l)=>{let o;if(t?o=L(e):o=L(e,l),I.appendChild(o),t){C(o,B);let n=Object.keys(i).length;o.oncontextmenu=r=>{A(r,n)},i[n]={type:e,inputs:y[e].inputs(),defaultInput:y[e].defaultInput,topOnly:y[e].topOnly,self:{}},H(o,n,e)}return o},H=(e,t,l)=>{y[l].load&&y[l].load.initDom&&y[l].load.initDom(i[t],e,t,!1)},F=e=>{let t=[];for(const l in i[e].inputs){let o=i[e].inputs[l];o.value&&o.value&&(t.push(o.value.data),t=t.concat(F(o.value.data)))}return t},K=e=>{q(e).remove(),i[e].prent&&(i[i[e].prent.blockId].inputs[i[e].prent.inputId].value=null);let t=F(e);for(const l of t)delete i[l];delete i[e]},v=(e,t)=>t=="x"?e.getBoundingClientRect().x+document.getElementById("zoom").scrollLeft/m:e.getBoundingClientRect().y+document.getElementById("zoom").scrollTop/m,pe=e=>{let t=F(e),l=Number(Object.keys(i)[Object.keys(i).length-1])+1;t.unshift(e);let o=document.querySelector(`[blockid="${e}"]`),n=o.cloneNode(!0);n.style.left=v(o,"x")+10+"px",n.style.top=v(o,"y")+10+"px",I.appendChild(n);for(const r of t){let d=i[r],s=re(d);i[String(Number(r)+l)]=s,y[d.type].save&&y[d.type].save.toFile&&y[d.type].save.toFile(s,n);let u=i[String(Number(r)+l)];document.createElement("div").appendChild(n.cloneNode(!0));let a=(p,g,k=()=>{})=>{let S=n.querySelectorAll(p)[0];S||(S=n),S.setAttribute(g,String(Number(r)+l)),k(S)},f=(p,g)=>{let k=n.querySelectorAll(p);for(let S of k)S.setAttribute(g,String(Number(r)+l))};u.prent&&(i[String(Number(r)+l)].prent.blockId=String(Number(i[String(Number(r)+l)].prent.blockId)+l)),a(`[blockid="${r}"]`,"blockid",p=>{let g=i[String(Number(r)+l)];r==e?(p.setAttribute("class","block"),C(p,B)):p.onmousedown=k=>{h(k,String(Number(r)+l),g.prent.blockId,g.prent.inputId)},H(p,String(Number(r)+l),g.type),p.oncontextmenu=k=>{A(k,String(Number(r)+l))}}),f(`[dragid="${r}"]`,"dragid");for(const p in u.inputs)f(`[prentid="${r}"][inputId="${p}"]`,"prentid"),u.inputs[p].value&&(u.inputs[p].value.data=String(Number(u.inputs[p].value.data)+l))}},ae=(e,t,l)=>{C(e,B),e.oncontextmenu=o=>{A(o,l)};for(const o of t)o.selfBlockDom.onmousedown=n=>{h(n,o.selfBlockId,o.prentId,o.targetBlockInputIndex)},o.selfBlockDom.oncontextmenu=n=>{A(n,o.selfBlockId)}},q=e=>document.querySelector(`[blockId="${e}"]`),N=()=>{E.style.display="none",D.open=!1},fe=e=>{E=document.getElementById("menu"),I=e,i={},D={},b=document.getElementById("porDom"),b.remove(),console.log(b),I.onmousedown=t=>{if(t.target.getAttribute("id")=="menuItem")return null;N()},document.getElementById("menuCopy").addEventListener("click",()=>{pe(D.target.data),N()}),document.getElementById("menuDelet").addEventListener("click",()=>{K(D.target.data),N()})},me=e=>{de(e)},ye=()=>ue(i),be=()=>ie(i);fe(document.getElementById("app"));x("move");x("ifelse");x("start");x("text");x("equalTo");x("number");document.getElementById("compiler").addEventListener("click",()=>{console.log(be())});document.getElementById("saveFile").addEventListener("click",()=>{alert("\u8BF7\u6309F12\u6253\u5F00\u63A7\u5236\u53F0\uFF0C\u67E5\u770B\u6587\u4EF6"),console.log("\u79EF\u6728\u6587\u4EF6",ye())});document.getElementById("loadFile").addEventListener("click",()=>{me(JSON.parse(prompt("\u6587\u4EF6json")))});
