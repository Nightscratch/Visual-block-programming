(function(x,b){typeof exports=="object"&&typeof module<"u"?b(exports):typeof define=="function"&&define.amd?define(["exports"],b):(x=typeof globalThis<"u"?globalThis:x||self,b(x.vb={}))})(this,function(x){"use strict";let b=1;const T=()=>{document.getElementById("app").style.zoom=b},Q=()=>{b+=.5,b>4&&(b=4),T()},W=()=>{b-=.5,b<.5&&(b=.5),T()};document.getElementById("zoomIn").addEventListener("click",W),document.getElementById("zoomOut").addEventListener("click",Q);const G=Object.freeze(Object.defineProperty({__proto__:null,get zoom(){return b}},Symbol.toStringTag,{value:"Module"}));let J=document.getElementById("app"),$=document.getElementById("zoom");const D=(e,t,n=!1)=>{let o,l,r=u=>{if(u.target!=e&&u.target.getAttribute("dragId")!=e.getAttribute("blockId")||u.button==2)return!0;u=u||window.event,u.preventDefault(),J.appendChild(e),o=e.getAttribute("blockId"),document.getElementById("screen").style.height=$.scrollTop+$.offsetHeight-16+"px",document.getElementById("screen").style.width=$.scrollLeft+$.offsetWidth-16+"px",l={y:u.clientY/b-(e.getBoundingClientRect().y+$.scrollTop/b),x:u.clientX/b-(e.getBoundingClientRect().x+$.scrollLeft/b)},document.onmouseup=s,document.onmousemove=d},d=u=>{u=u||window.event,u.preventDefault(),e.style.top=u.clientY/b-l.y+"px",e.style.left=u.clientX/b-l.x+"px",t(o,!1)},s=()=>{document.onmouseup=null,document.onmousemove=null,t(o)};e.onmousedown=r,n&&r(n)},U=`<div class="block-in" dragId="blockId">\r
    <div class="inline-block">\r
        <p dragId="blockId">Move(</p>\r
        <div class="input" prentId="blockId" inputId="arg1"></div>\r
        <p dragId="blockId">,</p>\r
        <div class="input" prentId="blockId" inputId="arg2"></div>\r
        <p dragId="blockId">)</p>\r
    </div>\r
</div>\r
\r
<div prentId="blockId" inputId="next"></div>`,V={defaultInput:"next",topOnly:!1,html(e){return U.replace(/blockId/g,e)},inputs(){return{arg1:{type:0,value:null},arg2:{type:0,value:null},next:{type:1,value:null}}},compiler(e,t){return`move(${e.arg1},${e.arg2});${e.next}`}},Z=`<div class="block-in" dragId="blockId">\r
    <div class="inline-block" dragId="blockId">\r
        <p dragId="blockId">\u5982\u679C</p>\r
        <div class="input" prentId="blockId" inputId="condition1"></div>\r
    </div>\r
</div>\r
<div class="inline">\r
    <div class="column"></div>\r
    <div class="input-transparent" prentId="blockId" inputId="do1"></div>\r
</div>\r
<div class="block-in" dragId="blockId">\r
    <div class="inline-block" dragId="blockId">\r
        <img class="right" src="./images/back.svg" />\r
    </div>\r
</div>\r
\r
<div prentId="blockId" inputId="next"></div>`,ee={defaultInput:"do1",topOnly:!1,html(e){return Z.replace(/blockId/g,e)},inputs(){return{do1:{type:1,value:null},condition1:{type:0,value:null},next:{type:1,value:null}}},compiler(e,t){return`if (${e.condition1}){${e.do1}}${e.next}`}},te=`\r
<div class="block-in">\r
    <div class="inline-block top-level" dragId="blockId">\r
        <p dragId="blockId">\u5F53\u7A0B\u5E8F\u542F\u52A8\u65F6</p>\r
    </div>\r
</div>\r
<div prentId="blockId" inputId="next"></div>`,ne={isTopLevel:!0,defaultInput:"next",topOnly:!0,html(e){return te.replace(/blockId/g,e)},inputs(){return{next:{type:1,value:null}}},compiler(e,t){return`const start =()=>{${e.next}}`}},le=`<div class="block-in">\r
    <div class="inline-block report-only" dragId="blockId">\r
            <p dragId="blockId">\u6587\u672C</p>\r
        <div>\r
            <input type="text" id="input">\r
        </div>\r
    </div>\r
</div>`,oe={defaultInput:null,topOnly:!0,html(e){return le.replace(/blockId/g,e)},inputs(){return{}},initialSelfData:{text:"\u9ED8\u8BA4\u6587\u672C"},compiler(e,t,n){return`"${n.querySelector('[id="input"]').value}"`},save:{toFile(e,t){return e.self.text=t.querySelector('[id="input"]').value,e}},load:{initDom(e,t){return t.querySelector('[id="input"]').value=e.self.text,t}}},ie=`<div class="block-in">\r
    <div class="inline-block report-only"  dragId="blockId">\r
        <p dragId="blockId">\u6570\u5B57</p>\r
        <div>\r
            <input id="input" type="number">\r
        </div>\r
    </div>\r
</div>`,re={defaultInput:null,topOnly:!0,html(e){return ie.replace(/blockId/g,e)},inputs(){return{}},compiler(e,t,n){return`${n.querySelector('[id="input"]').value}`},initialSelfData:{number:123456},save:{toFile(e,t){return e.self.number=t.querySelector('[id="input"]').value,e}},load:{initDom(e,t){return t.querySelector('[id="input"]').value=e.self.number,t}}},ue=`<div class="block-in" dragId="blockId">\r
    <div class="inline-block report-only" dragId="blockId">\r
        <p dragId="blockId">Array[</p>\r
        <div id="inputs" group="blockId" class="inline">\r
\r
        </div>\r
        <p dragId="blockId">]</p>\r
        <button id="add" prentId="blockId">\u52A0</button>\r
        <button id="subtract" prentId="blockId">\u51CF</button>\r
    </div>\r
</div>\r
\r
<div prentId="blockId" inputId="next"></div>`,de=`\r
\r
<div group="argId" prentId="blockId">\r
    <div class="input" prentId="blockId" inputId="argId"></div>, \r
</div>`,m={move:V,ifelse:ee,start:ne,text:oe,number:re,equalTo:{defaultInput:null,topOnly:!0,html(e){return ue.replace(/blockId/g,e)},inputs(){return{}},compiler(e,t){let n="";for(const o in e)n+=e[o]+",";return`[${n}]`},load:{initDom(e,t,n,o){let l=(d,s=!0)=>{let u=document.createElement("template");u.innerHTML=de.replace(/argId/g,d).replace(/blockId/g,n),s&&(e.inputs[d]={type:0,value:null}),t.querySelector('[id="inputs"]').appendChild(u.content)},r=()=>{let d=Object.keys(e.inputs);if(d.length>0){let s=e.inputs[d[d.length-1]];s.value&&R(s.value.data),t.querySelector(`[group="${d[d.length-1]}"][prentId="${n}"]`).remove(),delete e.inputs[d[d.length-1]]}};if(o){debugger;t.querySelector('[id="inputs"]').innerHTML="";for(let d in e.inputs)l(d,!1)}t.querySelector('[id="add"]').onclick=()=>{l(`item_${Object.keys(e.inputs).length+1}`)},t.querySelector('[id="subtract"]').onclick=d=>{r()}}}}};function ce(e){const t=new WeakMap;function n(l){return typeof l=="object"&&l||typeof l=="function"}function o(l){if(!n(l))return l;if([Date,RegExp].includes(l.constructor))return new l.constructor(l);if(typeof l=="function")return new Function("return "+l.toString())();const r=t.get(l);if(r)return r;if(l instanceof Map){const c=new Map;return t.set(l,c),l.forEach((a,f)=>{n(a)?c.set(f,o(a)):c.set(f,a)}),c}if(l instanceof Set){const c=new Set;return t.set(l,c),l.forEach(a=>{n(a)?c.add(o(a)):c.add(a)}),c}const d=Reflect.ownKeys(l),s=Object.getOwnPropertyDescriptors(l),u=Object.create(Object.getPrototypeOf(l),s);return t.set(l,u),d.forEach(c=>{const a=l[c];n(a)?u[c]=o(a):u[c]=a}),u}return o(e)}var E={};const F=(e,t)=>{let n=m[e.type],o={};for(const l in e.inputs){let r=e.inputs[l];r.value?o[l]=F(E[r.value.data],r.value.data):l=="next"?o[l]="":o[l]="null"}return n.compiler(o,e,document.querySelector(`[blockid="${t}"]`))},se=e=>{E=e;let t="";for(const n in E){let o=E[n];m[o.type].isTopLevel&&(t+=F(o,n))}return t},pe=e=>{let t={};for(const n in e){let o=e[n],l=document.querySelector(`[blockid="${n}"]`);console.log(l);let r=m[o.type];r.save&&r.save.toFile?t[n]=r.save.toFile(o,l):t[n]=o,t[n].x=l.style.left,t[n].y=l.style.top}return t};let _={},N=[];const L=(e,t,n)=>{let o=t[e],l=m[o.type];n.style.left=o.x,n.style.top=o.y,delete o.x,delete o.y,_[e]=o,l.load&&l.load.initDom&&l.load.initDom(o,n,e,!0);for(const r in o.inputs){let d=o.inputs[r];if(d.value){let s=P(t[d.value.data].type,d.value.data);N.push({selfBlockDom:s,selfBlockId:d.value.data,prentId:e,targetBlockInputIndex:r}),n.querySelector(`[inputid="${r}"]`).appendChild(L(d.value.data,t,s));debugger}}return n},ae=(e,t)=>{document.getElementById("app").innerHTML="",_={};for(const n in e){console.log("sss",e[n]);const o=e[n];if(!o.prent){debugger;N=[],Y(L(n,e,K(o.type,!1,n)),N,n);debugger}}},q=20;var g=null,i={},C={},w=null,v=null;const H=(e,t)=>{let n=e;if(!i[n].inputs[t])return e;for(;i[n].inputs[t].value;)n=i[n].inputs[t].value.data;return Number(n)},I=(e,t,n,o)=>{if(e.target.getAttribute("blockid")!=t&&e.target.getAttribute("dragId")!=t)return!0;if(e=e||window.e,e.preventDefault(),e.button==2)return null;delete i[t].prent;let l=g.querySelector(`[blockid="${t}"]`);i[n].inputs[o].value=null,l.style.top=k(l,"y")+"px",l.style.left=k(l,"x")+"px",l.setAttribute("class","block"),g.appendChild(l),D(l,h,e)},O=(e,t)=>{if(e=e||window.e,e.preventDefault(),e.target.getAttribute("blockid")!=t&&e.target.getAttribute("dragId")!=t)return null;w.style.display="block",w.style.top=e.clientY+5+"px",w.style.left=e.clientX+10+"px",C.open=!0,C.target={type:1,data:String(t)}},h=(e,t=!0)=>{t&&v.remove();let n=[],o=M(e);for(let r in i){let d=i[r];if(r!=e){for(const s in i[e].inputs){if(d.topOnly&&i[e].inputs[s].type==1||i[e].inputs[s].type!=1||i[r].prent||s!="next"&&i[e].inputs[s].value)continue;let u=M(r),c=document.querySelector(`[prentId="${e}"][inputId="${s}"]`),a=Math.abs(u.getBoundingClientRect().left-c.getBoundingClientRect().left),f=Math.abs(u.getBoundingClientRect().top-c.getBoundingClientRect().top),p=1;f<q&&a<q&&n.push({distance:a+f,targetBlockId:r,targetBlockDom:u,dragBlockInputId:s,type:p})}for(const s in d.inputs){if(!i[e].defaultInput&&d.inputs[s].type==1||i[e].topOnly&&d.inputs[s].type==1)continue;let u=document.querySelector(`[prentId="${r}"][inputId="${s}"]`),c=Math.abs(u.getBoundingClientRect().left-o.getBoundingClientRect().left),a=Math.abs(u.getBoundingClientRect().top-o.getBoundingClientRect().top);c<q&&a<q&&n.push({distance:c+a,targetBlockId:r,targetBlockInputIndex:s,targetBlockInputDom:u,type:0})}}}if(n.length==0)return v.remove(),null;n.sort((r,d)=>r.distance-d.distance);let l=n[0];if(l.type==0){let{targetBlockId:r,targetBlockInputIndex:d,targetBlockInputDom:s}=l;if(i[r].inputs[d].value){let u=i[r].inputs[d].value.data,c=M(u),a=H(e,"next");if(d=="next"){let f=i[e].defaultInput;if(!t)return s.insertBefore(v,s.childNodes[0]),!0;f!="next"&&!i[e].inputs[f].value?(document.querySelector(`[prentId="${e}"][inputId="${f}"]`).appendChild(c),i[e].inputs[f].value={type:1,data:u},i[u].prent={inputId:f,blockId:e},c.onmousedown=p=>{I(p,u,e,f)}):(document.querySelector(`[prentId="${a}"][inputId="next"]`).appendChild(c),i[a].inputs.next.value={type:1,data:u},i[u].prent={inputId:"next",blockId:a},c.onmousedown=p=>{I(p,u,a,"next")})}else{if(i[u].defaultInput)if(i[e].defaultInput){if(!t)return s.insertBefore(v,s.childNodes[0]),!0;let f=i[e].defaultInput,p;f=="next"?p=a:i[e].inputs[f].value?(p=a,f="next"):p=e,document.querySelector(`[prentId="${p}"][inputId="${f}"]`).appendChild(c),i[p].inputs[f].value={data:u,type:1},i[u].prent={inputId:f,blockId:p},c.onmousedown=y=>{I(y,u,p,f)}}else{if(!t)return s.append(v),!0;c.style.top=k(c,"y")+20+"px",c.style.left=k(c,"x")+20+"px",g.appendChild(c),delete i[u].prent,c.setAttribute("class","block"),D(c,h)}else{if(!t)return s.append(v),!0;c.style.top=k(c,"y")+20+"px",c.style.left=k(c,"x")+20+"px",g.appendChild(c),delete i[u].prent,c.setAttribute("class","block"),D(c,h)}debugger}}debugger;if(!t)return s.append(v),!0;i[r].inputs[d].value={type:1,data:e},i[e].prent={blockId:r,inputId:d},s.appendChild(o),o.setAttribute("class","block-input"),o.onmousedown=u=>{I(u,e,r,d)}}else if(l.type==1){let{targetBlockId:r,targetBlockDom:d,dragBlockInputId:s}=l,u=document.querySelector(`[prentId="${e}"][inputId="${s}"]`);if(!t)return u.append(v),!0;u.append(d),i[r].prent={blockId:e,inputId:s},i[e].inputs[s].value={type:1,data:r},d.setAttribute("class","block-input"),d.onmousedown=c=>{I(c,r,e,s)}}return null},j=(e,t=Object.keys(i).length)=>{let n=document.createElement("div");return n.setAttribute("blockId",`${t}`),n.setAttribute("class","block"),n.innerHTML=m[e].html(t),n},P=(e,t=Object.keys(i).length)=>{let n=j(e,t);return n.setAttribute("class","input-block"),n},K=(e,t=!0,n)=>{let o;if(t?o=j(e):o=j(e,n),g.appendChild(o),t){D(o,h);let l=Object.keys(i).length;o.oncontextmenu=r=>{O(r,l)},i[l]={type:e,inputs:m[e].inputs(),defaultInput:m[e].defaultInput,topOnly:m[e].topOnly},m[e].initialSelfData?i[l].self=m[e].initialSelfData:i[l].self={},X(o,l,e)}return o},X=(e,t,n)=>{m[n].load&&m[n].load.initDom&&m[n].load.initDom(i[t],e,t,!1)},A=e=>{let t=[];for(const n in i[e].inputs){let o=i[e].inputs[n];o.value&&o.value&&(t.push(o.value.data),t=t.concat(A(o.value.data)))}return t},R=e=>{M(e).remove(),i[e].prent&&(i[i[e].prent.blockId].inputs[i[e].prent.inputId].value=null);let t=A(e);for(const n of t)delete i[n];delete i[e]},k=(e,t)=>t=="x"?e.getBoundingClientRect().x-g.getBoundingClientRect().x+document.getElementById("zoom").scrollLeft/b:e.getBoundingClientRect().y-g.getBoundingClientRect().y+document.getElementById("zoom").scrollTop/b,fe=e=>{let t=A(e),n=Number(Object.keys(i)[Object.keys(i).length-1])+1;t.unshift(e);let o=document.querySelector(`[blockid="${e}"]`),l=o.cloneNode(!0);l.style.left=k(o,"x")+10+"px",l.style.top=k(o,"y")+10+"px",g.appendChild(l);for(const r of t){let d=i[r],s=ce(d);i[String(Number(r)+n)]=s,m[d.type].save&&m[d.type].save.toFile&&m[d.type].save.toFile(s,l);let u=i[String(Number(r)+n)];document.createElement("div").appendChild(l.cloneNode(!0));let a=(p,y,S=()=>{})=>{let B=l.querySelectorAll(p)[0];B||(B=l),B.setAttribute(y,String(Number(r)+n)),S(B)},f=(p,y)=>{let S=l.querySelectorAll(p);for(let B of S)B.setAttribute(y,String(Number(r)+n))};u.prent&&(i[String(Number(r)+n)].prent.blockId=String(Number(i[String(Number(r)+n)].prent.blockId)+n)),a(`[blockid="${r}"]`,"blockid",p=>{debugger;let y=i[String(Number(r)+n)];r==e?(p.setAttribute("class","block"),D(p,h)):p.onmousedown=S=>{I(S,String(Number(r)+n),y.prent.blockId,y.prent.inputId)},X(p,String(Number(r)+n),y.type),p.oncontextmenu=S=>{O(S,String(Number(r)+n))}}),f(`[dragid="${r}"]`,"dragid");for(const p in u.inputs)f(`[prentid="${r}"][inputId="${p}"]`,"prentid"),f(`[prentid="${r}"][group="${p}"]`,"prentid"),u.inputs[p].value&&(u.inputs[p].value.data=String(Number(u.inputs[p].value.data)+n))}},Y=(e,t,n)=>{D(e,h),e.oncontextmenu=o=>{O(o,n)};for(const o of t)o.selfBlockDom.onmousedown=l=>{I(l,o.selfBlockId,o.prentId,o.targetBlockInputIndex)},o.selfBlockDom.oncontextmenu=l=>{O(l,o.selfBlockId)}},M=e=>document.querySelector(`[blockId="${e}"]`),z=()=>{w.style.display="none",C.open=!1},be=Object.freeze(Object.defineProperty({__proto__:null,getMinChild:H,setDragOut:I,setContext:O,connectBlocks:h,addInputBlock:P,addBlock:K,getAllChildBlock:A,deletBlock:R,bindEvent:Y,init:e=>{w=document.getElementById("menu"),g=e,i={},C={},v=document.getElementById("porDom"),v.remove(),g.onmousedown=t=>{if(t.target.getAttribute("id")=="menuItem")return null;z()},document.getElementById("menuCopy").addEventListener("click",()=>{fe(C.target.data),z()}),document.getElementById("menuDelet").addEventListener("click",()=>{R(C.target.data),z()})},loadFile:e=>{ae(e)},saveFile:()=>pe(i),compile:()=>se(i)},Symbol.toStringTag,{value:"Module"}));x.block=be,x.zoom=G,Object.defineProperties(x,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
//# sourceMappingURL=vb.umd.js.map
